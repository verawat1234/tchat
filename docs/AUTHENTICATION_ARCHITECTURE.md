# Tchat Authentication Architecture

**Generated by Agent System**: SearchAgent + CodeAgent + Architect Persona
**Date**: 2025-09-30
**Version**: 1.0

---

## 📋 Table of Contents

1. [System Overview](#system-overview)
2. [Complete Authentication Flow](#complete-authentication-flow)
3. [Component Architecture](#component-architecture)
4. [JWT Token System](#jwt-token-system)
5. [OTP Authentication Flow](#otp-authentication-flow)
6. [Session Management](#session-management)
7. [Security Architecture](#security-architecture)
8. [Cross-Platform Integration](#cross-platform-integration)
9. [Data Flow Diagrams](#data-flow-diagrams)

---

## System Overview

Tchat implements a **multi-platform authentication system** with JWT tokens, OTP verification, and KYC support across:
- **Backend**: Go microservices (Auth Service on port 8081)
- **Web**: React + TypeScript with RTK Query
- **Mobile**: Kotlin Multiplatform (Android + iOS)

### Core Authentication Methods
1. **OTP Authentication** (Primary) - Phone number + SMS OTP
2. **Email/Password** (Secondary) - Traditional credentials
3. **Social Login** (Planned) - OAuth integration

---

## Complete Authentication Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    TCHAT AUTHENTICATION ARCHITECTURE                            │
│                         Multi-Platform JWT System                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT PLATFORMS                                        │
├──────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  ┌─────────────────┐    ┌──────────────────┐    ┌────────────────────────┐        │
│  │   WEB CLIENT    │    │  MOBILE (KMP)    │    │   MOBILE (NATIVE)      │        │
│  │  React + RTK    │    │  Compose Multi   │    │  Android / iOS         │        │
│  │                 │    │                  │    │                        │        │
│  │ AuthScreen.tsx  │    │ AuthScreen.kt    │    │ SwiftUI / Jetpack      │        │
│  │ auth.ts         │    │ AuthService.kt   │    │                        │        │
│  │ authSlice.ts    │    │ SessionManager   │    │ Secure Storage         │        │
│  │                 │    │                  │    │ - Keychain (iOS)       │        │
│  │ Token Storage:  │    │ Token Storage:   │    │ - EncryptedSharedPrefs │        │
│  │ - localStorage  │    │ - Keychain       │    │                        │        │
│  │ - Redux state   │    │ - EncryptedPrefs │    │                        │        │
│  └────────┬────────┘    └─────────┬────────┘    └───────────┬────────────┘        │
│           │                       │                         │                      │
│           └───────────────────────┴─────────────────────────┘                      │
│                                   │                                                │
│                            HTTPS (TLS 1.3)                                         │
│                            Authorization: Bearer <JWT>                             │
│                                   │                                                │
└───────────────────────────────────┼────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                          API GATEWAY (Port 8080)                                     │
│                            Route Distribution                                        │
├──────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                         Middleware Chain                                     │  │
│  │                                                                              │  │
│  │  1. CORS Middleware              → Allow origins, methods                   │  │
│  │  2. Security Middleware          → Rate limiting, IP filtering              │  │
│  │  3. Authentication Middleware    → JWT validation (if protected)            │  │
│  │  4. Authorization Middleware     → Permission/scope checking                │  │
│  │  5. Request Logging              → Audit trail                              │  │
│  └──────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  Route Mapping:                                                                     │
│  /api/v1/auth/*         → Auth Service (8081)                                       │
│  /api/v1/content/*      → Content Service (8082)                                    │
│  /api/v1/commerce/*     → Commerce Service (8083)                                   │
│  /api/v1/messaging/*    → Messaging Service (8084)                                  │
│  /api/v1/social/*       → Social Service (8092)                                     │
│                                                                                      │
└───────────────────────────────────┬──────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                       AUTH SERVICE (Port 8081)                                       │
│                    Go + Gin + GORM + PostgreSQL                                      │
├──────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────┐    │
│  │                          HTTP HANDLERS                                     │    │
│  │                      (handlers/auth.go)                                    │    │
│  │                                                                            │    │
│  │  POST   /auth/otp/send           → SendOTP(phoneNumber, countryCode)      │    │
│  │  POST   /auth/otp/verify         → VerifyOTP(phoneNumber, code)           │    │
│  │  POST   /auth/register           → Register(email, password, profile)     │    │
│  │  POST   /auth/login              → Login(email, password)                 │    │
│  │  POST   /auth/refresh            → RefreshToken(refreshToken)             │    │
│  │  POST   /auth/logout             → Logout(sessionID)                      │    │
│  │  GET    /auth/profile            → GetProfile(userID) [Protected]         │    │
│  │  PUT    /auth/profile            → UpdateProfile(userID, data) [Prot.]    │    │
│  │  POST   /auth/kyc/verify         → VerifyKYC(userID, documents)           │    │
│  │  GET    /auth/session            → GetSession(sessionID) [Protected]      │    │
│  └────────────────────────────────────────────────────────────────────────────┘    │
│                                       │                                             │
│                                       ▼                                             │
│  ┌────────────────────────────────────────────────────────────────────────────┐    │
│  │                         SERVICE LAYER                                      │    │
│  │                                                                            │    │
│  │  ┌───────────────────┐  ┌──────────────────┐  ┌────────────────────┐     │    │
│  │  │  AuthService      │  │   JWTService     │  │  SessionService    │     │    │
│  │  │                   │  │                  │  │                    │     │    │
│  │  │ • SendOTP()       │  │ • Generate       │  │ • CreateSession()  │     │    │
│  │  │ • VerifyOTP()     │  │   TokenPair()    │  │ • ValidateSession()│     │    │
│  │  │ • Register()      │  │ • ValidateToken()│  │ • RevokeSession()  │     │    │
│  │  │ • Login()         │  │ • RefreshToken() │  │ • CleanupExpired() │     │    │
│  │  │ • Logout()        │  │ • RevokeToken()  │  │                    │     │    │
│  │  └───────────────────┘  └──────────────────┘  └────────────────────┘     │    │
│  │                                                                            │    │
│  │  ┌───────────────────┐  ┌──────────────────┐  ┌────────────────────┐     │    │
│  │  │  UserService      │  │   KYCService     │  │  SecurityLogger    │     │    │
│  │  │                   │  │                  │  │                    │     │    │
│  │  │ • CreateUser()    │  │ • VerifyKYC()    │  │ • LogLoginAttempt()│     │    │
│  │  │ • GetUser()       │  │ • GetKYCLevel()  │  │ • LogOTPGen()      │     │    │
│  │  │ • UpdateProfile() │  │ • UpdateStatus() │  │ • LogSuspicious()  │     │    │
│  │  │ • DeleteUser()    │  │                  │  │                    │     │    │
│  │  └───────────────────┘  └──────────────────┘  └────────────────────┘     │    │
│  └────────────────────────────────────────────────────────────────────────────┘    │
│                                       │                                             │
│                                       ▼                                             │
│  ┌────────────────────────────────────────────────────────────────────────────┐    │
│  │                         MIDDLEWARE LAYER                                   │    │
│  │                (shared/middleware/auth.go, jwt.go)                         │    │
│  │                                                                            │    │
│  │  ┌──────────────────────────────────────────────────────────────────────┐ │    │
│  │  │  RequireAuth()                                                       │ │    │
│  │  │  ├─ Extract JWT from Authorization header                           │ │    │
│  │  │  ├─ Validate signature & expiration                                 │ │    │
│  │  │  ├─ Parse UserClaims (userID, sessionID, KYC level, permissions)    │ │    │
│  │  │  ├─ Set user context in Gin                                         │ │    │
│  │  │  └─ Continue or abort with 401                                      │ │    │
│  │  └──────────────────────────────────────────────────────────────────────┘ │    │
│  │                                                                            │    │
│  │  ┌──────────────────────────────────────────────────────────────────────┐ │    │
│  │  │  RequireKYC(minLevel int)                                            │ │    │
│  │  │  ├─ Check KYC level from claims                                     │ │    │
│  │  │  ├─ Verify level >= minLevel                                        │ │    │
│  │  │  └─ Continue or abort with 403                                      │ │    │
│  │  └──────────────────────────────────────────────────────────────────────┘ │    │
│  │                                                                            │    │
│  │  ┌──────────────────────────────────────────────────────────────────────┐ │    │
│  │  │  RateLimiter                                                         │ │    │
│  │  │  ├─ Track requests by IP/userID                                     │ │    │
│  │  │  ├─ Apply limits (login: 5/min, OTP: 3/hour)                        │ │    │
│  │  │  └─ Block or allow                                                  │ │    │
│  │  └──────────────────────────────────────────────────────────────────────┘ │    │
│  └────────────────────────────────────────────────────────────────────────────┘    │
│                                       │                                             │
│                                       ▼                                             │
│  ┌────────────────────────────────────────────────────────────────────────────┐    │
│  │                         DATA LAYER                                         │    │
│  │                                                                            │    │
│  │  ┌──────────────────┐  ┌───────────────────┐  ┌─────────────────────┐    │    │
│  │  │  PostgreSQL DB   │  │   Redis Cache     │  │   SMS Provider      │    │    │
│  │  │                  │  │                   │  │   (Twilio/AWS SNS)  │    │    │
│  │  │ Tables:          │  │ Cached Data:      │  │                     │    │    │
│  │  │ • users          │  │ • Session tokens  │  │ • SendOTP()         │    │    │
│  │  │ • sessions       │  │ • User profiles   │  │ • GetCredits()      │    │    │
│  │  │ • otps           │  │ • Rate limits     │  │                     │    │    │
│  │  │ • kyc_records    │  │ • Blacklists      │  │                     │    │    │
│  │  │ • audit_logs     │  │                   │  │                     │    │    │
│  │  └──────────────────┘  └───────────────────┘  └─────────────────────┘    │    │
│  └────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────┐
│                      OTHER MICROSERVICES (Protected)                                 │
├──────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  All services validate JWT tokens via shared middleware:                            │
│                                                                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐  │
│  │ Content Service │  │ Commerce Service│  │ Messaging Svc   │  │ Social Svc   │  │
│  │   (Port 8082)   │  │   (Port 8083)   │  │  (Port 8084)    │  │ (Port 8092)  │  │
│  │                 │  │                 │  │                 │  │              │  │
│  │ Requires:       │  │ Requires:       │  │ Requires:       │  │ Requires:    │  │
│  │ • Valid JWT     │  │ • Valid JWT     │  │ • Valid JWT     │  │ • Valid JWT  │  │
│  │ • User context  │  │ • KYC Level 1+  │  │ • Active session│  │ • User data  │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └──────────────┘  │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Component Architecture

### Backend Components

```
backend/auth/
├── handlers/
│   └── auth.go                    # HTTP endpoint handlers
├── services/
│   ├── auth_service.go            # Core authentication logic
│   ├── jwt_service.go             # JWT token management
│   ├── jwt_service_test.go        # JWT service tests
│   ├── session_service.go         # Session lifecycle management
│   ├── user_service.go            # User account operations
│   └── kyc_service.go             # KYC verification
├── models/
│   ├── user.go                    # User data model
│   ├── session.go                 # Session data model
│   └── kyc.go                     # KYC data model
├── shared/middleware/
│   ├── auth.go                    # Auth middleware
│   ├── jwt.go                     # JWT validation middleware
│   └── security.go                # Security middleware
└── tests/
    └── contract/                  # Pact contract tests
        ├── pact_provider_test.go
        ├── service_interfaces.go
        └── mock_services.go
```

### Web Components

```
apps/web/src/
├── components/
│   └── AuthScreen.tsx             # Login/registration UI
├── services/
│   └── auth.ts                    # Auth API client (RTK Query)
├── features/
│   └── authSlice.ts               # Redux auth state management
├── store/middleware/
│   └── authMiddleware.ts          # Auth middleware for Redux
├── types/
│   └── api.ts                     # API type definitions
└── contracts/tests/
    ├── auth-service.pact.test.ts  # Auth service contract
    └── auth-profile.pact.test.ts  # Profile contract
```

### Mobile Components (KMP)

```
apps/kmp/composeApp/src/
├── commonMain/kotlin/com/tchat/mobile/
│   ├── services/
│   │   ├── AuthService.kt         # Auth service implementation
│   │   └── AuthPersistenceManager.kt # Token storage
│   ├── api/
│   │   ├── ApiClient.kt           # API client with auth
│   │   └── models/ApiModels.kt    # API request/response models
│   ├── models/
│   │   ├── User.kt                # User model
│   │   └── UserSession.kt         # Session model
│   └── screens/
│       └── AuthScreen.kt          # Login/registration UI
├── androidMain/kotlin/
│   └── services/
│       └── AuthPersistenceManager.android.kt # Android secure storage
└── iosMain/kotlin/
    └── services/
        └── AuthPersistenceManager.ios.kt     # iOS Keychain storage
```

---

## JWT Token System

### Token Structure

```
┌──────────────────────────────────────────────────────────────────┐
│                    JWT TOKEN STRUCTURE                           │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ACCESS TOKEN (15 minutes TTL)                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ Header:                                                    │ │
│  │ {                                                          │ │
│  │   "alg": "HS256",                                          │ │
│  │   "typ": "JWT"                                             │ │
│  │ }                                                          │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ Payload (UserClaims):                                      │ │
│  │ {                                                          │ │
│  │   "user_id": "uuid",            # User unique identifier  │ │
│  │   "phone_number": "+66812...",  # User phone              │ │
│  │   "country_code": "TH",         # Country                 │ │
│  │   "kyc_status": "verified",     # KYC verification status │ │
│  │   "kyc_level": 2,               # KYC level (0-3)         │ │
│  │   "session_id": "uuid",         # Session identifier      │ │
│  │   "device_id": "device-123",    # Device fingerprint      │ │
│  │   "permissions": [...],         # User permissions        │ │
│  │   "scopes": ["read", "write"],  # OAuth scopes            │ │
│  │   "iss": "tchat.dev",           # Issuer                  │ │
│  │   "aud": "tchat-app",           # Audience                │ │
│  │   "exp": 1234567890,            # Expiration timestamp    │ │
│  │   "iat": 1234567890,            # Issued at timestamp     │ │
│  │   "nbf": 1234567890             # Not before timestamp    │ │
│  │ }                                                          │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ Signature:                                                 │ │
│  │ HMACSHA256(                                                │ │
│  │   base64UrlEncode(header) + "." +                          │ │
│  │   base64UrlEncode(payload),                                │ │
│  │   secret                                                   │ │
│  │ )                                                          │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  REFRESH TOKEN (7 days TTL)                                      │
│  • Similar structure but different secret                        │
│  • Longer expiration                                             │
│  • Used only for token refresh endpoint                          │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### Token Generation Flow (backend/auth/services/jwt_service.go)

```go
func (js *JWTService) GenerateTokenPair(
    ctx context.Context,
    user *User,
    sessionID uuid.UUID,
    deviceID string
) (*TokenPair, error) {
    now := time.Now()

    // Create access token (15 minutes)
    accessClaims := UserClaims{
        UserID:      user.ID,
        PhoneNumber: user.PhoneNumber,
        CountryCode: user.CountryCode,
        KYCStatus:   user.KYCStatus,
        KYCLevel:    user.KYCLevel,
        SessionID:   sessionID,
        DeviceID:    deviceID,
        Permissions: user.Permissions,
        RegisteredClaims: jwt.RegisteredClaims{
            Issuer:    js.issuer,
            Audience:  jwt.ClaimStrings{js.audience},
            ExpiresAt: jwt.NewNumericDate(now.Add(15 * time.Minute)),
            IssuedAt:  jwt.NewNumericDate(now),
            NotBefore: jwt.NewNumericDate(now),
        },
    }

    accessToken := jwt.NewWithClaims(jwt.SigningMethodHS256, accessClaims)
    accessTokenString, err := accessToken.SignedString(js.accessSecret)

    // Create refresh token (7 days)
    refreshClaims := UserClaims{
        UserID:    user.ID,
        SessionID: sessionID,
        RegisteredClaims: jwt.RegisteredClaims{
            ExpiresAt: jwt.NewNumericDate(now.Add(7 * 24 * time.Hour)),
            IssuedAt:  jwt.NewNumericDate(now),
        },
    }

    refreshToken := jwt.NewWithClaims(jwt.SigningMethodHS256, refreshClaims)
    refreshTokenString, err := refreshToken.SignedString(js.refreshSecret)

    return &TokenPair{
        AccessToken:      accessTokenString,
        RefreshToken:     refreshTokenString,
        TokenType:        "Bearer",
        ExpiresIn:        900,  // 15 minutes in seconds
        AccessExpiresAt:  now.Add(15 * time.Minute),
        RefreshExpiresAt: now.Add(7 * 24 * time.Hour),
    }, nil
}
```

### Token Validation Flow (backend/shared/middleware/auth.go)

```go
func (am *AuthMiddleware) RequireAuth() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 1. Extract token from Authorization header
        token := am.extractToken(c)  // "Bearer <token>"

        // 2. Validate JWT signature and expiration
        claims, err := am.validateToken(token)
        if err != nil {
            c.JSON(401, gin.H{"error": "Invalid or expired token"})
            c.Abort()
            return
        }

        // 3. Set user context for downstream handlers
        c.Set("user_id", claims.UserID)
        c.Set("session_id", claims.SessionID)
        c.Set("kyc_level", claims.KYCLevel)
        c.Set("permissions", claims.Permissions)

        c.Next()
    }
}
```

---

## OTP Authentication Flow

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                        OTP AUTHENTICATION FLOW                                       │
│                  (Primary authentication method)                                     │
└──────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐                ┌─────────────┐                ┌─────────────────┐
│   CLIENT    │                │  AUTH SVC   │                │  SMS PROVIDER   │
│ (Web/Mobile)│                │  (Port 8081)│                │  (Twilio/SNS)   │
└──────┬──────┘                └──────┬──────┘                └────────┬────────┘
       │                              │                                │
       │ 1. Request OTP               │                                │
       │ POST /auth/otp/send          │                                │
       │ {                            │                                │
       │   phone_number: "+66812...", │                                │
       │   country_code: "TH"         │                                │
       │ }                            │                                │
       ├─────────────────────────────>│                                │
       │                              │                                │
       │                              │ 2. Validate request            │
       │                              │ • Check rate limits            │
       │                              │ • Verify phone format          │
       │                              │ • Check attempt count          │
       │                              │                                │
       │                              │ 3. Generate OTP                │
       │                              │ • Random 6-digit code          │
       │                              │ • Hash code (bcrypt)           │
       │                              │ • Store in database            │
       │                              │   - expires_at: +5 minutes     │
       │                              │   - max_attempts: 3            │
       │                              │   - status: pending            │
       │                              │                                │
       │                              │ 4. Send SMS                    │
       │                              ├───────────────────────────────>│
       │                              │ SendOTP(                       │
       │                              │   to: "+66812...",             │
       │                              │   message: "Your OTP: 123456"  │
       │                              │ )                              │
       │                              │                                │
       │                              │<───────────────────────────────┤
       │                              │ SMS Delivery ID                │
       │                              │                                │
       │<─────────────────────────────┤                                │
       │ 200 OK                       │                                │
       │ {                            │                                │
       │   success: true,             │                                │
       │   message: "OTP sent",       │                                │
       │   expires_in: 300            │                                │
       │ }                            │                                │
       │                              │                                │
       │ 5. User receives SMS         │                                │
       │ "Your Tchat OTP: 123456"     │                                │
       │ (Valid for 5 minutes)        │                                │
       │                              │                                │
       │ 6. Submit OTP                │                                │
       │ POST /auth/otp/verify        │                                │
       │ {                            │                                │
       │   phone_number: "+66812...", │                                │
       │   code: "123456"             │                                │
       │ }                            │                                │
       ├─────────────────────────────>│                                │
       │                              │                                │
       │                              │ 7. Validate OTP                │
       │                              │ • Retrieve OTP record          │
       │                              │ • Check expiration             │
       │                              │ • Check attempt count          │
       │                              │ • Verify hashed code           │
       │                              │                                │
       │                              │ 8. Create/update user          │
       │                              │ • Find or create user          │
       │                              │ • Update last_login            │
       │                              │ • Update phone_verified        │
       │                              │                                │
       │                              │ 9. Create session              │
       │                              │ • Generate session_id          │
       │                              │ • Store session in DB          │
       │                              │ • Set expiration: 30 days      │
       │                              │                                │
       │                              │ 10. Generate JWT tokens        │
       │                              │ • AccessToken (15 min)         │
       │                              │ • RefreshToken (7 days)        │
       │                              │                                │
       │<─────────────────────────────┤                                │
       │ 200 OK                       │                                │
       │ {                            │                                │
       │   user: { id, phone, ... },  │                                │
       │   access_token: "eyJ...",    │                                │
       │   refresh_token: "eyJ...",   │                                │
       │   expires_in: 900,           │                                │
       │   token_type: "Bearer"       │                                │
       │ }                            │                                │
       │                              │                                │
       │ 11. Store tokens             │                                │
       │ • Web: localStorage          │                                │
       │ • Mobile: Keychain/          │                                │
       │   EncryptedSharedPreferences │                                │
       │                              │                                │
       │ 12. Authenticated!           │                                │
       │ All subsequent requests      │                                │
       │ include:                     │                                │
       │ Authorization: Bearer <JWT>  │                                │
       │                              │                                │
       ▼                              ▼                                ▼
```

### OTP Security Features

1. **Rate Limiting**
   - 3 OTP requests per hour per phone number
   - 5 verification attempts per OTP
   - IP-based rate limiting (10 requests/min)

2. **Expiration**
   - OTP expires after 5 minutes
   - Automatic cleanup of expired OTPs

3. **Attempt Tracking**
   - Max 3 verification attempts per OTP
   - Account lockout after 5 failed OTPs

4. **Logging**
   - All OTP requests logged with IP, user agent
   - Failed attempts tracked for security analysis
   - Suspicious activity alerts

---

## Session Management

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                          SESSION LIFECYCLE                                           │
└──────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            SESSION CREATION                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  After successful authentication (OTP verify or login):                             │
│                                                                                     │
│  1. SessionService.CreateSession(userID, deviceID, ipAddress, userAgent)            │
│     ├─ Generate unique session_id (UUID)                                            │
│     ├─ Store session in PostgreSQL:                                                 │
│     │  {                                                                             │
│     │    session_id: uuid,                                                           │
│     │    user_id: uuid,                                                              │
│     │    device_id: "device-123",                                                    │
│     │    device_type: "mobile",                                                      │
│     │    ip_address: "1.2.3.4",                                                      │
│     │    user_agent: "Mozilla/...",                                                  │
│     │    created_at: timestamp,                                                      │
│     │    last_activity: timestamp,                                                   │
│     │    expires_at: now + 30 days,                                                  │
│     │    is_active: true,                                                            │
│     │    metadata: {                                                                 │
│     │      location: "Bangkok, TH",                                                  │
│     │      login_method: "otp"                                                       │
│     │    }                                                                            │
│     │  }                                                                             │
│     │                                                                                │
│     └─ Cache in Redis (TTL: 30 days):                                               │
│        Key: "session:{session_id}"                                                   │
│        Value: serialized session data                                                │
│                                                                                     │
│  2. Generate JWT token pair with session_id in claims                               │
│                                                                                     │
│  3. Return tokens to client                                                         │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            SESSION VALIDATION                                       │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  On each protected request:                                                         │
│                                                                                     │
│  1. Extract JWT from Authorization header                                           │
│  2. Validate JWT signature and expiration                                           │
│  3. Extract session_id from claims                                                  │
│  4. SessionService.ValidateSession(session_id)                                      │
│     ├─ Check Redis cache first (fast path)                                          │
│     ├─ If not in cache, query PostgreSQL                                            │
│     ├─ Verify session is active and not expired                                     │
│     ├─ Update last_activity timestamp                                               │
│     └─ Return session valid/invalid                                                 │
│                                                                                     │
│  5. If valid, allow request to proceed                                              │
│  6. If invalid, return 401 Unauthorized                                             │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            SESSION REVOCATION                                       │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  User logout or security event:                                                     │
│                                                                                     │
│  1. SessionService.RevokeSession(session_id)                                        │
│     ├─ Set is_active = false in PostgreSQL                                          │
│     ├─ Remove from Redis cache                                                      │
│     ├─ Add session_id to blacklist in Redis (TTL: token expiry)                    │
│     └─ Log revocation event                                                         │
│                                                                                     │
│  2. All subsequent requests with this session fail                                  │
│                                                                                     │
│  Security scenarios triggering revocation:                                          │
│  • User explicit logout                                                             │
│  • Password change                                                                  │
│  • Suspicious activity detected                                                     │
│  • Multiple failed authentication attempts                                          │
│  • Admin-initiated revocation                                                       │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          SESSION CLEANUP & MAINTENANCE                              │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  Background job runs every 1 hour:                                                  │
│                                                                                     │
│  1. SessionService.CleanupExpiredSessions()                                         │
│     ├─ DELETE FROM sessions WHERE expires_at < NOW()                                │
│     ├─ Remove expired sessions from Redis                                           │
│     └─ Log cleanup statistics                                                       │
│                                                                                     │
│  2. Monitor active sessions per user                                                │
│     • Alert if > 5 active sessions                                                  │
│     • Revoke oldest sessions if limit exceeded                                      │
│                                                                                     │
│  3. Analyze session patterns                                                        │
│     • Track average session duration                                                │
│     • Identify unusual access patterns                                              │
│     • Generate security reports                                                     │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### Session Database Schema

```sql
CREATE TABLE sessions (
    session_id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(user_id),
    device_id VARCHAR(255) NOT NULL,
    device_type VARCHAR(50),
    device_name VARCHAR(255),
    ip_address VARCHAR(45),
    user_agent TEXT,
    location VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    last_activity TIMESTAMP NOT NULL DEFAULT NOW(),
    expires_at TIMESTAMP NOT NULL,
    is_active BOOLEAN DEFAULT true,
    revoked_at TIMESTAMP,
    revocation_reason TEXT,
    metadata JSONB,

    INDEX idx_sessions_user_id (user_id),
    INDEX idx_sessions_expires_at (expires_at),
    INDEX idx_sessions_is_active (is_active)
);
```

---

## Security Architecture

### Multi-Layer Security

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                            SECURITY LAYERS                                           │
├──────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  Layer 1: TRANSPORT SECURITY                                                         │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │ • TLS 1.3 encryption for all communications                                    │ │
│  │ • Certificate pinning on mobile apps                                           │ │
│  │ • HTTPS only (no HTTP allowed)                                                 │ │
│  │ • Perfect Forward Secrecy (PFS) enabled                                        │ │
│  └────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                      │
│  Layer 2: API GATEWAY SECURITY                                                       │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │ • Rate limiting (per IP, per user)                                             │ │
│  │ • DDoS protection                                                              │ │
│  │ • IP whitelisting/blacklisting                                                 │ │
│  │ • Request size limits                                                          │ │
│  │ • CORS policy enforcement                                                      │ │
│  └────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                      │
│  Layer 3: AUTHENTICATION                                                             │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │ • JWT token validation                                                         │ │
│  │ • Token expiration enforcement                                                 │ │
│  │ • Session validation                                                           │ │
│  │ • Multi-factor authentication (OTP)                                            │ │
│  │ • Token blacklist for revoked sessions                                         │ │
│  └────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                      │
│  Layer 4: AUTHORIZATION                                                              │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │ • KYC level enforcement                                                        │ │
│  │ • Permission-based access control                                              │ │
│  │ • Resource ownership validation                                                │ │
│  │ • Scope-based API access                                                       │ │
│  └────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                      │
│  Layer 5: DATA PROTECTION                                                            │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │ • Password hashing (bcrypt, cost 12)                                           │ │
│  │ • OTP code hashing                                                             │ │
│  │ • Sensitive data encryption at rest                                            │ │
│  │ • PII data masking in logs                                                     │ │
│  │ • Secure token storage (Keychain, EncryptedSharedPreferences)                  │ │
│  └────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                      │
│  Layer 6: MONITORING & LOGGING                                                       │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │ • Audit log for all authentication events                                      │ │
│  │ • Failed login attempt tracking                                                │ │
│  │ • Suspicious activity detection                                                │ │
│  │ • Real-time security alerts                                                    │ │
│  │ • Comprehensive security metrics                                               │ │
│  └────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘
```

### Rate Limiting Strategy

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                            RATE LIMITING RULES                                       │
├──────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  Endpoint-Specific Limits:                                                           │
│                                                                                      │
│  POST /auth/otp/send                                                                 │
│  ├─ Per phone number: 3 requests per hour                                            │
│  ├─ Per IP address: 10 requests per hour                                             │
│  └─ Global: 1000 requests per minute                                                 │
│                                                                                      │
│  POST /auth/otp/verify                                                               │
│  ├─ Per phone number: 5 attempts per OTP                                             │
│  ├─ Per IP address: 20 attempts per hour                                             │
│  └─ Lock account after 10 failed verifications in 24h                                │
│                                                                                      │
│  POST /auth/login                                                                    │
│  ├─ Per user: 5 attempts per 15 minutes                                              │
│  ├─ Per IP address: 10 attempts per 15 minutes                                       │
│  └─ Lock account after 5 consecutive failures                                        │
│                                                                                      │
│  POST /auth/refresh                                                                  │
│  ├─ Per user: 10 requests per minute                                                 │
│  └─ Per IP address: 30 requests per minute                                           │
│                                                                                      │
│  General API (authenticated):                                                        │
│  ├─ Per user: 1000 requests per minute                                               │
│  └─ Per IP address: 3000 requests per minute                                         │
│                                                                                      │
│  Implementation:                                                                     │
│  • Redis-based sliding window counters                                               │
│  • Distributed rate limiting across instances                                        │
│  • 429 Too Many Requests with Retry-After header                                     │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Cross-Platform Integration

### Token Storage by Platform

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                       TOKEN STORAGE STRATEGIES                                       │
├──────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  WEB (apps/web/src/)                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │ Primary: localStorage                                                          │ │
│  │ • Key: "tchat_access_token", "tchat_refresh_token"                             │ │
│  │ • Automatic persistence across sessions                                        │ │
│  │ • XSS protection via Content Security Policy                                   │ │
│  │                                                                                │ │
│  │ Secondary: Redux state                                                         │ │
│  │ • In-memory during active session                                              │ │
│  │ • Redux Persist syncs with localStorage                                        │ │
│  │                                                                                │ │
│  │ Security measures:                                                             │ │
│  │ • HttpOnly cookies (not used for JWT, but for CSRF token)                     │ │
│  │ • SameSite=Strict cookie policy                                                │ │
│  │ • Automatic token refresh on expiry                                            │ │
│  └────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                      │
│  MOBILE - ANDROID (apps/kmp/.../android/)                                            │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │ Primary: EncryptedSharedPreferences (Android Keystore)                         │ │
│  │ • Backed by hardware security module if available                              │ │
│  │ • AES-256-GCM encryption                                                       │ │
│  │ • Key: "auth_tokens"                                                           │ │
│  │ • Value: JSON { accessToken, refreshToken, expiresAt }                        │ │
│  │                                                                                │ │
│  │ Implementation:                                                                │ │
│  │ ```kotlin                                                                      │ │
│  │ val encryptedPrefs = EncryptedSharedPreferences.create(                        │ │
│  │     context,                                                                   │ │
│  │     "auth_prefs",                                                              │ │
│  │     masterKey,                                                                 │ │
│  │     EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,            │ │
│  │     EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM           │ │
│  │ )                                                                              │ │
│  │ ```                                                                            │ │
│  └────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                      │
│  MOBILE - iOS (apps/kmp/.../ios/)                                                    │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │ Primary: iOS Keychain (kSecClassGenericPassword)                               │ │
│  │ • Hardware-backed encryption (Secure Enclave)                                  │ │
│  │ • Access control: kSecAttrAccessibleWhenUnlockedThisDeviceOnly                 │ │
│  │ • Biometric protection optional                                                │ │
│  │                                                                                │ │
│  │ Implementation:                                                                │ │
│  │ ```swift                                                                       │ │
│  │ let query: [String: Any] = [                                                   │ │
│  │     kSecClass as String: kSecClassGenericPassword,                             │ │
│  │     kSecAttrAccount as String: "auth_tokens",                                  │ │
│  │     kSecAttrService as String: "com.tchat.mobile",                             │ │
│  │     kSecValueData as String: tokenData,                                        │ │
│  │     kSecAttrAccessible as String:                                              │ │
│  │         kSecAttrAccessibleWhenUnlockedThisDeviceOnly                           │ │
│  │ ]                                                                              │ │
│  │ SecItemAdd(query as CFDictionary, nil)                                         │ │
│  │ ```                                                                            │ │
│  └────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘
```

### Token Refresh Flow (All Platforms)

```
Client                          Auth Service
  │                                  │
  │ 1. API request with              │
  │    expired access token          │
  ├─────────────────────────────────>│
  │                                  │
  │<─────────────────────────────────┤
  │ 401 Unauthorized                 │
  │ { error: "token_expired" }       │
  │                                  │
  │ 2. Auto-trigger token refresh    │
  │ POST /auth/refresh               │
  │ { refresh_token: "..." }         │
  ├─────────────────────────────────>│
  │                                  │
  │                                  │ 3. Validate refresh token
  │                                  │    • Check signature
  │                                  │    • Verify not expired
  │                                  │    • Check not blacklisted
  │                                  │    • Validate session active
  │                                  │
  │                                  │ 4. Generate new token pair
  │                                  │    • New access token (15 min)
  │                                  │    • New refresh token (7 days)
  │                                  │
  │<─────────────────────────────────┤
  │ 200 OK                           │
  │ {                                │
  │   access_token: "new_token",     │
  │   refresh_token: "new_refresh",  │
  │   expires_in: 900                │
  │ }                                │
  │                                  │
  │ 5. Store new tokens              │
  │    Platform-specific storage     │
  │                                  │
  │ 6. Retry original request        │
  │    with new access token         │
  ├─────────────────────────────────>│
  │                                  │
  │<─────────────────────────────────┤
  │ 200 OK (success)                 │
  │                                  │
```

---

## Data Flow Diagrams

### Complete Request Flow with Authentication

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│               AUTHENTICATED API REQUEST FLOW                                         │
│            (Example: Get user profile)                                               │
└──────────────────────────────────────────────────────────────────────────────────────┘

Web/Mobile Client
    │
    │ GET /api/v1/auth/profile
    │ Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
    │ X-Device-ID: device-123
    │ X-App-Version: 1.2.0
    │
    ▼
┌────────────────────────────────────────┐
│      API Gateway (Port 8080)           │
│                                        │
│  1. CORS Middleware                    │
│     ├─ Verify origin allowed           │
│     └─ Add CORS headers                │
│                                        │
│  2. Security Middleware                │
│     ├─ Rate limit check                │
│     ├─ IP validation                   │
│     └─ Request size check              │
│                                        │
│  3. Extract JWT token                  │
│     └─ Authorization header            │
│                                        │
└────────────────┬───────────────────────┘
                 │
                 │ Forward to Auth Service
                 │ /auth/profile
                 │
                 ▼
┌────────────────────────────────────────┐
│    Auth Service (Port 8081)            │
│                                        │
│  4. Auth Middleware Chain              │
│     ├─ RequireAuth()                   │
│     │  ├─ Validate JWT signature       │
│     │  ├─ Check expiration             │
│     │  ├─ Parse UserClaims             │
│     │  └─ Set user context             │
│     │                                  │
│     └─ RequireKYC(minLevel: 0)         │
│        └─ Verify KYC level ≥ 0         │
│                                        │
│  5. Handler: GetProfile()              │
│     ├─ Extract user_id from context    │
│     ├─ Call UserService.GetUser()      │
│     └─ Format response                 │
│                                        │
└────────────────┬───────────────────────┘
                 │
                 │ Query user data
                 │
                 ▼
┌────────────────────────────────────────┐
│       Database Layer                   │
│                                        │
│  6. UserService                        │
│     ├─ Check Redis cache               │
│     │  Key: "user:{user_id}"           │
│     │                                  │
│     ├─ If not cached:                  │
│     │  └─ Query PostgreSQL             │
│     │     SELECT * FROM users          │
│     │     WHERE user_id = $1           │
│     │                                  │
│     └─ Cache result in Redis           │
│        TTL: 5 minutes                  │
│                                        │
└────────────────┬───────────────────────┘
                 │
                 │ Return user data
                 │
                 ▼
┌────────────────────────────────────────┐
│    Auth Service Response               │
│                                        │
│  7. Format response                    │
│     {                                  │
│       user: {                          │
│         id: "uuid",                    │
│         phone_number: "+66...",        │
│         kyc_status: "verified",        │
│         created_at: "2025-01-15"       │
│       }                                │
│     }                                  │
│                                        │
└────────────────┬───────────────────────┘
                 │
                 │ HTTP 200 OK
                 │
                 ▼
┌────────────────────────────────────────┐
│      API Gateway                       │
│                                        │
│  8. Add response headers               │
│     ├─ X-Request-ID                    │
│     ├─ X-Response-Time                 │
│     └─ CORS headers                    │
│                                        │
└────────────────┬───────────────────────┘
                 │
                 │ Return to client
                 │
                 ▼
Web/Mobile Client
    │
    │ Receive user profile
    │ Update UI state
    │
```

---

## Summary

### Key Features

✅ **Multi-Platform Support**: Web (React), Mobile (KMP - Android & iOS)
✅ **JWT Token System**: Access (15 min) + Refresh (7 days) tokens
✅ **OTP Authentication**: Primary auth method with SMS verification
✅ **Session Management**: 30-day sessions with active tracking
✅ **KYC Integration**: Multi-level KYC support with verification
✅ **Rate Limiting**: Comprehensive rate limiting per endpoint
✅ **Security Layers**: 6-layer security architecture
✅ **Cross-Platform Sync**: Unified auth state across all clients
✅ **Secure Storage**: Platform-specific secure token storage
✅ **Comprehensive Logging**: Full audit trail for security analysis

### File Count by Category

- **Backend Services**: 194 files (Go)
- **Web Frontend**: 91 files (TypeScript/React)
- **Mobile Apps**: 64 files (Kotlin Multiplatform)
- **Total**: **349 authentication-related files**

### API Endpoints Summary

**Auth Service (8081)**:
- `POST /auth/otp/send` - Request OTP
- `POST /auth/otp/verify` - Verify OTP and login
- `POST /auth/register` - Register with email/password
- `POST /auth/login` - Login with email/password
- `POST /auth/refresh` - Refresh access token
- `POST /auth/logout` - Logout and revoke session
- `GET /auth/profile` - Get user profile [Protected]
- `PUT /auth/profile` - Update user profile [Protected]
- `POST /auth/kyc/verify` - Verify KYC documents [Protected]
- `GET /auth/session` - Get session details [Protected]

---

**Generated by**: Agent System (SearchAgent + CodeAgent + Architect Persona)
**Last Updated**: 2025-09-30
**Version**: 1.0