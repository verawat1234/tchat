# Tchat Authentication Architecture

**Generated by Agent System**: SearchAgent + CodeAgent + Architect Persona
**Date**: 2025-09-30
**Version**: 1.0

---

## ğŸ“‹ Table of Contents

1. [System Overview](#system-overview)
2. [Complete Authentication Flow](#complete-authentication-flow)
3. [Component Architecture](#component-architecture)
4. [JWT Token System](#jwt-token-system)
5. [OTP Authentication Flow](#otp-authentication-flow)
6. [Session Management](#session-management)
7. [Security Architecture](#security-architecture)
8. [Cross-Platform Integration](#cross-platform-integration)
9. [Data Flow Diagrams](#data-flow-diagrams)

---

## System Overview

Tchat implements a **multi-platform authentication system** with JWT tokens, OTP verification, and KYC support across:
- **Backend**: Go microservices (Auth Service on port 8081)
- **Web**: React + TypeScript with RTK Query
- **Mobile**: Kotlin Multiplatform (Android + iOS)

### Core Authentication Methods
1. **OTP Authentication** (Primary) - Phone number + SMS OTP
2. **Email/Password** (Secondary) - Traditional credentials
3. **Social Login** (Planned) - OAuth integration

---

## Complete Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TCHAT AUTHENTICATION ARCHITECTURE                            â”‚
â”‚                         Multi-Platform JWT System                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CLIENT PLATFORMS                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   WEB CLIENT    â”‚    â”‚  MOBILE (KMP)    â”‚    â”‚   MOBILE (NATIVE)      â”‚        â”‚
â”‚  â”‚  React + RTK    â”‚    â”‚  Compose Multi   â”‚    â”‚  Android / iOS         â”‚        â”‚
â”‚  â”‚                 â”‚    â”‚                  â”‚    â”‚                        â”‚        â”‚
â”‚  â”‚ AuthScreen.tsx  â”‚    â”‚ AuthScreen.kt    â”‚    â”‚ SwiftUI / Jetpack      â”‚        â”‚
â”‚  â”‚ auth.ts         â”‚    â”‚ AuthService.kt   â”‚    â”‚                        â”‚        â”‚
â”‚  â”‚ authSlice.ts    â”‚    â”‚ SessionManager   â”‚    â”‚ Secure Storage         â”‚        â”‚
â”‚  â”‚                 â”‚    â”‚                  â”‚    â”‚ - Keychain (iOS)       â”‚        â”‚
â”‚  â”‚ Token Storage:  â”‚    â”‚ Token Storage:   â”‚    â”‚ - EncryptedSharedPrefs â”‚        â”‚
â”‚  â”‚ - localStorage  â”‚    â”‚ - Keychain       â”‚    â”‚                        â”‚        â”‚
â”‚  â”‚ - Redux state   â”‚    â”‚ - EncryptedPrefs â”‚    â”‚                        â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚                       â”‚                         â”‚                      â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                   â”‚                                                â”‚
â”‚                            HTTPS (TLS 1.3)                                         â”‚
â”‚                            Authorization: Bearer <JWT>                             â”‚
â”‚                                   â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          API GATEWAY (Port 8080)                                     â”‚
â”‚                            Route Distribution                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         Middleware Chain                                     â”‚  â”‚
â”‚  â”‚                                                                              â”‚  â”‚
â”‚  â”‚  1. CORS Middleware              â†’ Allow origins, methods                   â”‚  â”‚
â”‚  â”‚  2. Security Middleware          â†’ Rate limiting, IP filtering              â”‚  â”‚
â”‚  â”‚  3. Authentication Middleware    â†’ JWT validation (if protected)            â”‚  â”‚
â”‚  â”‚  4. Authorization Middleware     â†’ Permission/scope checking                â”‚  â”‚
â”‚  â”‚  5. Request Logging              â†’ Audit trail                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                      â”‚
â”‚  Route Mapping:                                                                     â”‚
â”‚  /api/v1/auth/*         â†’ Auth Service (8081)                                       â”‚
â”‚  /api/v1/content/*      â†’ Content Service (8082)                                    â”‚
â”‚  /api/v1/commerce/*     â†’ Commerce Service (8083)                                   â”‚
â”‚  /api/v1/messaging/*    â†’ Messaging Service (8084)                                  â”‚
â”‚  /api/v1/social/*       â†’ Social Service (8092)                                     â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       AUTH SERVICE (Port 8081)                                       â”‚
â”‚                    Go + Gin + GORM + PostgreSQL                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                          HTTP HANDLERS                                     â”‚    â”‚
â”‚  â”‚                      (handlers/auth.go)                                    â”‚    â”‚
â”‚  â”‚                                                                            â”‚    â”‚
â”‚  â”‚  POST   /auth/otp/send           â†’ SendOTP(phoneNumber, countryCode)      â”‚    â”‚
â”‚  â”‚  POST   /auth/otp/verify         â†’ VerifyOTP(phoneNumber, code)           â”‚    â”‚
â”‚  â”‚  POST   /auth/register           â†’ Register(email, password, profile)     â”‚    â”‚
â”‚  â”‚  POST   /auth/login              â†’ Login(email, password)                 â”‚    â”‚
â”‚  â”‚  POST   /auth/refresh            â†’ RefreshToken(refreshToken)             â”‚    â”‚
â”‚  â”‚  POST   /auth/logout             â†’ Logout(sessionID)                      â”‚    â”‚
â”‚  â”‚  GET    /auth/profile            â†’ GetProfile(userID) [Protected]         â”‚    â”‚
â”‚  â”‚  PUT    /auth/profile            â†’ UpdateProfile(userID, data) [Prot.]    â”‚    â”‚
â”‚  â”‚  POST   /auth/kyc/verify         â†’ VerifyKYC(userID, documents)           â”‚    â”‚
â”‚  â”‚  GET    /auth/session            â†’ GetSession(sessionID) [Protected]      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                       â”‚                                             â”‚
â”‚                                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         SERVICE LAYER                                      â”‚    â”‚
â”‚  â”‚                                                                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚  AuthService      â”‚  â”‚   JWTService     â”‚  â”‚  SessionService    â”‚     â”‚    â”‚
â”‚  â”‚  â”‚                   â”‚  â”‚                  â”‚  â”‚                    â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ SendOTP()       â”‚  â”‚ â€¢ Generate       â”‚  â”‚ â€¢ CreateSession()  â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ VerifyOTP()     â”‚  â”‚   TokenPair()    â”‚  â”‚ â€¢ ValidateSession()â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ Register()      â”‚  â”‚ â€¢ ValidateToken()â”‚  â”‚ â€¢ RevokeSession()  â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ Login()         â”‚  â”‚ â€¢ RefreshToken() â”‚  â”‚ â€¢ CleanupExpired() â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ Logout()        â”‚  â”‚ â€¢ RevokeToken()  â”‚  â”‚                    â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â”‚                                                                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚  UserService      â”‚  â”‚   KYCService     â”‚  â”‚  SecurityLogger    â”‚     â”‚    â”‚
â”‚  â”‚  â”‚                   â”‚  â”‚                  â”‚  â”‚                    â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ CreateUser()    â”‚  â”‚ â€¢ VerifyKYC()    â”‚  â”‚ â€¢ LogLoginAttempt()â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ GetUser()       â”‚  â”‚ â€¢ GetKYCLevel()  â”‚  â”‚ â€¢ LogOTPGen()      â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ UpdateProfile() â”‚  â”‚ â€¢ UpdateStatus() â”‚  â”‚ â€¢ LogSuspicious()  â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ DeleteUser()    â”‚  â”‚                  â”‚  â”‚                    â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                       â”‚                                             â”‚
â”‚                                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         MIDDLEWARE LAYER                                   â”‚    â”‚
â”‚  â”‚                (shared/middleware/auth.go, jwt.go)                         â”‚    â”‚
â”‚  â”‚                                                                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚  RequireAuth()                                                       â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ Extract JWT from Authorization header                           â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ Validate signature & expiration                                 â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ Parse UserClaims (userID, sessionID, KYC level, permissions)    â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ Set user context in Gin                                         â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€ Continue or abort with 401                                      â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â”‚                                                                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚  RequireKYC(minLevel int)                                            â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ Check KYC level from claims                                     â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ Verify level >= minLevel                                        â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€ Continue or abort with 403                                      â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â”‚                                                                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚  RateLimiter                                                         â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ Track requests by IP/userID                                     â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ Apply limits (login: 5/min, OTP: 3/hour)                        â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€ Block or allow                                                  â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                       â”‚                                             â”‚
â”‚                                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         DATA LAYER                                         â”‚    â”‚
â”‚  â”‚                                                                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚  PostgreSQL DB   â”‚  â”‚   Redis Cache     â”‚  â”‚   SMS Provider      â”‚    â”‚    â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚                   â”‚  â”‚   (Twilio/AWS SNS)  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ Tables:          â”‚  â”‚ Cached Data:      â”‚  â”‚                     â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ users          â”‚  â”‚ â€¢ Session tokens  â”‚  â”‚ â€¢ SendOTP()         â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ sessions       â”‚  â”‚ â€¢ User profiles   â”‚  â”‚ â€¢ GetCredits()      â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ otps           â”‚  â”‚ â€¢ Rate limits     â”‚  â”‚                     â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ kyc_records    â”‚  â”‚ â€¢ Blacklists      â”‚  â”‚                     â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ audit_logs     â”‚  â”‚                   â”‚  â”‚                     â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      OTHER MICROSERVICES (Protected)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  All services validate JWT tokens via shared middleware:                            â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Content Service â”‚  â”‚ Commerce Serviceâ”‚  â”‚ Messaging Svc   â”‚  â”‚ Social Svc   â”‚  â”‚
â”‚  â”‚   (Port 8082)   â”‚  â”‚   (Port 8083)   â”‚  â”‚  (Port 8084)    â”‚  â”‚ (Port 8092)  â”‚  â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚              â”‚  â”‚
â”‚  â”‚ Requires:       â”‚  â”‚ Requires:       â”‚  â”‚ Requires:       â”‚  â”‚ Requires:    â”‚  â”‚
â”‚  â”‚ â€¢ Valid JWT     â”‚  â”‚ â€¢ Valid JWT     â”‚  â”‚ â€¢ Valid JWT     â”‚  â”‚ â€¢ Valid JWT  â”‚  â”‚
â”‚  â”‚ â€¢ User context  â”‚  â”‚ â€¢ KYC Level 1+  â”‚  â”‚ â€¢ Active sessionâ”‚  â”‚ â€¢ User data  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Architecture

### Backend Components

```
backend/auth/
â”œâ”€â”€ handlers/
â”‚   â””â”€â”€ auth.go                    # HTTP endpoint handlers
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ auth_service.go            # Core authentication logic
â”‚   â”œâ”€â”€ jwt_service.go             # JWT token management
â”‚   â”œâ”€â”€ jwt_service_test.go        # JWT service tests
â”‚   â”œâ”€â”€ session_service.go         # Session lifecycle management
â”‚   â”œâ”€â”€ user_service.go            # User account operations
â”‚   â””â”€â”€ kyc_service.go             # KYC verification
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ user.go                    # User data model
â”‚   â”œâ”€â”€ session.go                 # Session data model
â”‚   â””â”€â”€ kyc.go                     # KYC data model
â”œâ”€â”€ shared/middleware/
â”‚   â”œâ”€â”€ auth.go                    # Auth middleware
â”‚   â”œâ”€â”€ jwt.go                     # JWT validation middleware
â”‚   â””â”€â”€ security.go                # Security middleware
â””â”€â”€ tests/
    â””â”€â”€ contract/                  # Pact contract tests
        â”œâ”€â”€ pact_provider_test.go
        â”œâ”€â”€ service_interfaces.go
        â””â”€â”€ mock_services.go
```

### Web Components

```
apps/web/src/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ AuthScreen.tsx             # Login/registration UI
â”œâ”€â”€ services/
â”‚   â””â”€â”€ auth.ts                    # Auth API client (RTK Query)
â”œâ”€â”€ features/
â”‚   â””â”€â”€ authSlice.ts               # Redux auth state management
â”œâ”€â”€ store/middleware/
â”‚   â””â”€â”€ authMiddleware.ts          # Auth middleware for Redux
â”œâ”€â”€ types/
â”‚   â””â”€â”€ api.ts                     # API type definitions
â””â”€â”€ contracts/tests/
    â”œâ”€â”€ auth-service.pact.test.ts  # Auth service contract
    â””â”€â”€ auth-profile.pact.test.ts  # Profile contract
```

### Mobile Components (KMP)

```
apps/kmp/composeApp/src/
â”œâ”€â”€ commonMain/kotlin/com/tchat/mobile/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ AuthService.kt         # Auth service implementation
â”‚   â”‚   â””â”€â”€ AuthPersistenceManager.kt # Token storage
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ ApiClient.kt           # API client with auth
â”‚   â”‚   â””â”€â”€ models/ApiModels.kt    # API request/response models
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ User.kt                # User model
â”‚   â”‚   â””â”€â”€ UserSession.kt         # Session model
â”‚   â””â”€â”€ screens/
â”‚       â””â”€â”€ AuthScreen.kt          # Login/registration UI
â”œâ”€â”€ androidMain/kotlin/
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ AuthPersistenceManager.android.kt # Android secure storage
â””â”€â”€ iosMain/kotlin/
    â””â”€â”€ services/
        â””â”€â”€ AuthPersistenceManager.ios.kt     # iOS Keychain storage
```

---

## JWT Token System

### Token Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    JWT TOKEN STRUCTURE                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ACCESS TOKEN (15 minutes TTL)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Header:                                                    â”‚ â”‚
â”‚  â”‚ {                                                          â”‚ â”‚
â”‚  â”‚   "alg": "HS256",                                          â”‚ â”‚
â”‚  â”‚   "typ": "JWT"                                             â”‚ â”‚
â”‚  â”‚ }                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Payload (UserClaims):                                      â”‚ â”‚
â”‚  â”‚ {                                                          â”‚ â”‚
â”‚  â”‚   "user_id": "uuid",            # User unique identifier  â”‚ â”‚
â”‚  â”‚   "phone_number": "+66812...",  # User phone              â”‚ â”‚
â”‚  â”‚   "country_code": "TH",         # Country                 â”‚ â”‚
â”‚  â”‚   "kyc_status": "verified",     # KYC verification status â”‚ â”‚
â”‚  â”‚   "kyc_level": 2,               # KYC level (0-3)         â”‚ â”‚
â”‚  â”‚   "session_id": "uuid",         # Session identifier      â”‚ â”‚
â”‚  â”‚   "device_id": "device-123",    # Device fingerprint      â”‚ â”‚
â”‚  â”‚   "permissions": [...],         # User permissions        â”‚ â”‚
â”‚  â”‚   "scopes": ["read", "write"],  # OAuth scopes            â”‚ â”‚
â”‚  â”‚   "iss": "tchat.dev",           # Issuer                  â”‚ â”‚
â”‚  â”‚   "aud": "tchat-app",           # Audience                â”‚ â”‚
â”‚  â”‚   "exp": 1234567890,            # Expiration timestamp    â”‚ â”‚
â”‚  â”‚   "iat": 1234567890,            # Issued at timestamp     â”‚ â”‚
â”‚  â”‚   "nbf": 1234567890             # Not before timestamp    â”‚ â”‚
â”‚  â”‚ }                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Signature:                                                 â”‚ â”‚
â”‚  â”‚ HMACSHA256(                                                â”‚ â”‚
â”‚  â”‚   base64UrlEncode(header) + "." +                          â”‚ â”‚
â”‚  â”‚   base64UrlEncode(payload),                                â”‚ â”‚
â”‚  â”‚   secret                                                   â”‚ â”‚
â”‚  â”‚ )                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  REFRESH TOKEN (7 days TTL)                                      â”‚
â”‚  â€¢ Similar structure but different secret                        â”‚
â”‚  â€¢ Longer expiration                                             â”‚
â”‚  â€¢ Used only for token refresh endpoint                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Token Generation Flow (backend/auth/services/jwt_service.go)

```go
func (js *JWTService) GenerateTokenPair(
    ctx context.Context,
    user *User,
    sessionID uuid.UUID,
    deviceID string
) (*TokenPair, error) {
    now := time.Now()

    // Create access token (15 minutes)
    accessClaims := UserClaims{
        UserID:      user.ID,
        PhoneNumber: user.PhoneNumber,
        CountryCode: user.CountryCode,
        KYCStatus:   user.KYCStatus,
        KYCLevel:    user.KYCLevel,
        SessionID:   sessionID,
        DeviceID:    deviceID,
        Permissions: user.Permissions,
        RegisteredClaims: jwt.RegisteredClaims{
            Issuer:    js.issuer,
            Audience:  jwt.ClaimStrings{js.audience},
            ExpiresAt: jwt.NewNumericDate(now.Add(15 * time.Minute)),
            IssuedAt:  jwt.NewNumericDate(now),
            NotBefore: jwt.NewNumericDate(now),
        },
    }

    accessToken := jwt.NewWithClaims(jwt.SigningMethodHS256, accessClaims)
    accessTokenString, err := accessToken.SignedString(js.accessSecret)

    // Create refresh token (7 days)
    refreshClaims := UserClaims{
        UserID:    user.ID,
        SessionID: sessionID,
        RegisteredClaims: jwt.RegisteredClaims{
            ExpiresAt: jwt.NewNumericDate(now.Add(7 * 24 * time.Hour)),
            IssuedAt:  jwt.NewNumericDate(now),
        },
    }

    refreshToken := jwt.NewWithClaims(jwt.SigningMethodHS256, refreshClaims)
    refreshTokenString, err := refreshToken.SignedString(js.refreshSecret)

    return &TokenPair{
        AccessToken:      accessTokenString,
        RefreshToken:     refreshTokenString,
        TokenType:        "Bearer",
        ExpiresIn:        900,  // 15 minutes in seconds
        AccessExpiresAt:  now.Add(15 * time.Minute),
        RefreshExpiresAt: now.Add(7 * 24 * time.Hour),
    }, nil
}
```

### Token Validation Flow (backend/shared/middleware/auth.go)

```go
func (am *AuthMiddleware) RequireAuth() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 1. Extract token from Authorization header
        token := am.extractToken(c)  // "Bearer <token>"

        // 2. Validate JWT signature and expiration
        claims, err := am.validateToken(token)
        if err != nil {
            c.JSON(401, gin.H{"error": "Invalid or expired token"})
            c.Abort()
            return
        }

        // 3. Set user context for downstream handlers
        c.Set("user_id", claims.UserID)
        c.Set("session_id", claims.SessionID)
        c.Set("kyc_level", claims.KYCLevel)
        c.Set("permissions", claims.Permissions)

        c.Next()
    }
}
```

---

## OTP Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        OTP AUTHENTICATION FLOW                                       â”‚
â”‚                  (Primary authentication method)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLIENT    â”‚                â”‚  AUTH SVC   â”‚                â”‚  SMS PROVIDER   â”‚
â”‚ (Web/Mobile)â”‚                â”‚  (Port 8081)â”‚                â”‚  (Twilio/SNS)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â”‚                                â”‚
       â”‚ 1. Request OTP               â”‚                                â”‚
       â”‚ POST /auth/otp/send          â”‚                                â”‚
       â”‚ {                            â”‚                                â”‚
       â”‚   phone_number: "+66812...", â”‚                                â”‚
       â”‚   country_code: "TH"         â”‚                                â”‚
       â”‚ }                            â”‚                                â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                â”‚
       â”‚                              â”‚                                â”‚
       â”‚                              â”‚ 2. Validate request            â”‚
       â”‚                              â”‚ â€¢ Check rate limits            â”‚
       â”‚                              â”‚ â€¢ Verify phone format          â”‚
       â”‚                              â”‚ â€¢ Check attempt count          â”‚
       â”‚                              â”‚                                â”‚
       â”‚                              â”‚ 3. Generate OTP                â”‚
       â”‚                              â”‚ â€¢ Random 6-digit code          â”‚
       â”‚                              â”‚ â€¢ Hash code (bcrypt)           â”‚
       â”‚                              â”‚ â€¢ Store in database            â”‚
       â”‚                              â”‚   - expires_at: +5 minutes     â”‚
       â”‚                              â”‚   - max_attempts: 3            â”‚
       â”‚                              â”‚   - status: pending            â”‚
       â”‚                              â”‚                                â”‚
       â”‚                              â”‚ 4. Send SMS                    â”‚
       â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                              â”‚ SendOTP(                       â”‚
       â”‚                              â”‚   to: "+66812...",             â”‚
       â”‚                              â”‚   message: "Your OTP: 123456"  â”‚
       â”‚                              â”‚ )                              â”‚
       â”‚                              â”‚                                â”‚
       â”‚                              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                              â”‚ SMS Delivery ID                â”‚
       â”‚                              â”‚                                â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                â”‚
       â”‚ 200 OK                       â”‚                                â”‚
       â”‚ {                            â”‚                                â”‚
       â”‚   success: true,             â”‚                                â”‚
       â”‚   message: "OTP sent",       â”‚                                â”‚
       â”‚   expires_in: 300            â”‚                                â”‚
       â”‚ }                            â”‚                                â”‚
       â”‚                              â”‚                                â”‚
       â”‚ 5. User receives SMS         â”‚                                â”‚
       â”‚ "Your Tchat OTP: 123456"     â”‚                                â”‚
       â”‚ (Valid for 5 minutes)        â”‚                                â”‚
       â”‚                              â”‚                                â”‚
       â”‚ 6. Submit OTP                â”‚                                â”‚
       â”‚ POST /auth/otp/verify        â”‚                                â”‚
       â”‚ {                            â”‚                                â”‚
       â”‚   phone_number: "+66812...", â”‚                                â”‚
       â”‚   code: "123456"             â”‚                                â”‚
       â”‚ }                            â”‚                                â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                â”‚
       â”‚                              â”‚                                â”‚
       â”‚                              â”‚ 7. Validate OTP                â”‚
       â”‚                              â”‚ â€¢ Retrieve OTP record          â”‚
       â”‚                              â”‚ â€¢ Check expiration             â”‚
       â”‚                              â”‚ â€¢ Check attempt count          â”‚
       â”‚                              â”‚ â€¢ Verify hashed code           â”‚
       â”‚                              â”‚                                â”‚
       â”‚                              â”‚ 8. Create/update user          â”‚
       â”‚                              â”‚ â€¢ Find or create user          â”‚
       â”‚                              â”‚ â€¢ Update last_login            â”‚
       â”‚                              â”‚ â€¢ Update phone_verified        â”‚
       â”‚                              â”‚                                â”‚
       â”‚                              â”‚ 9. Create session              â”‚
       â”‚                              â”‚ â€¢ Generate session_id          â”‚
       â”‚                              â”‚ â€¢ Store session in DB          â”‚
       â”‚                              â”‚ â€¢ Set expiration: 30 days      â”‚
       â”‚                              â”‚                                â”‚
       â”‚                              â”‚ 10. Generate JWT tokens        â”‚
       â”‚                              â”‚ â€¢ AccessToken (15 min)         â”‚
       â”‚                              â”‚ â€¢ RefreshToken (7 days)        â”‚
       â”‚                              â”‚                                â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                â”‚
       â”‚ 200 OK                       â”‚                                â”‚
       â”‚ {                            â”‚                                â”‚
       â”‚   user: { id, phone, ... },  â”‚                                â”‚
       â”‚   access_token: "eyJ...",    â”‚                                â”‚
       â”‚   refresh_token: "eyJ...",   â”‚                                â”‚
       â”‚   expires_in: 900,           â”‚                                â”‚
       â”‚   token_type: "Bearer"       â”‚                                â”‚
       â”‚ }                            â”‚                                â”‚
       â”‚                              â”‚                                â”‚
       â”‚ 11. Store tokens             â”‚                                â”‚
       â”‚ â€¢ Web: localStorage          â”‚                                â”‚
       â”‚ â€¢ Mobile: Keychain/          â”‚                                â”‚
       â”‚   EncryptedSharedPreferences â”‚                                â”‚
       â”‚                              â”‚                                â”‚
       â”‚ 12. Authenticated!           â”‚                                â”‚
       â”‚ All subsequent requests      â”‚                                â”‚
       â”‚ include:                     â”‚                                â”‚
       â”‚ Authorization: Bearer <JWT>  â”‚                                â”‚
       â”‚                              â”‚                                â”‚
       â–¼                              â–¼                                â–¼
```

### OTP Security Features

1. **Rate Limiting**
   - 3 OTP requests per hour per phone number
   - 5 verification attempts per OTP
   - IP-based rate limiting (10 requests/min)

2. **Expiration**
   - OTP expires after 5 minutes
   - Automatic cleanup of expired OTPs

3. **Attempt Tracking**
   - Max 3 verification attempts per OTP
   - Account lockout after 5 failed OTPs

4. **Logging**
   - All OTP requests logged with IP, user agent
   - Failed attempts tracked for security analysis
   - Suspicious activity alerts

---

## Session Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SESSION LIFECYCLE                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            SESSION CREATION                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  After successful authentication (OTP verify or login):                             â”‚
â”‚                                                                                     â”‚
â”‚  1. SessionService.CreateSession(userID, deviceID, ipAddress, userAgent)            â”‚
â”‚     â”œâ”€ Generate unique session_id (UUID)                                            â”‚
â”‚     â”œâ”€ Store session in PostgreSQL:                                                 â”‚
â”‚     â”‚  {                                                                             â”‚
â”‚     â”‚    session_id: uuid,                                                           â”‚
â”‚     â”‚    user_id: uuid,                                                              â”‚
â”‚     â”‚    device_id: "device-123",                                                    â”‚
â”‚     â”‚    device_type: "mobile",                                                      â”‚
â”‚     â”‚    ip_address: "1.2.3.4",                                                      â”‚
â”‚     â”‚    user_agent: "Mozilla/...",                                                  â”‚
â”‚     â”‚    created_at: timestamp,                                                      â”‚
â”‚     â”‚    last_activity: timestamp,                                                   â”‚
â”‚     â”‚    expires_at: now + 30 days,                                                  â”‚
â”‚     â”‚    is_active: true,                                                            â”‚
â”‚     â”‚    metadata: {                                                                 â”‚
â”‚     â”‚      location: "Bangkok, TH",                                                  â”‚
â”‚     â”‚      login_method: "otp"                                                       â”‚
â”‚     â”‚    }                                                                            â”‚
â”‚     â”‚  }                                                                             â”‚
â”‚     â”‚                                                                                â”‚
â”‚     â””â”€ Cache in Redis (TTL: 30 days):                                               â”‚
â”‚        Key: "session:{session_id}"                                                   â”‚
â”‚        Value: serialized session data                                                â”‚
â”‚                                                                                     â”‚
â”‚  2. Generate JWT token pair with session_id in claims                               â”‚
â”‚                                                                                     â”‚
â”‚  3. Return tokens to client                                                         â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            SESSION VALIDATION                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  On each protected request:                                                         â”‚
â”‚                                                                                     â”‚
â”‚  1. Extract JWT from Authorization header                                           â”‚
â”‚  2. Validate JWT signature and expiration                                           â”‚
â”‚  3. Extract session_id from claims                                                  â”‚
â”‚  4. SessionService.ValidateSession(session_id)                                      â”‚
â”‚     â”œâ”€ Check Redis cache first (fast path)                                          â”‚
â”‚     â”œâ”€ If not in cache, query PostgreSQL                                            â”‚
â”‚     â”œâ”€ Verify session is active and not expired                                     â”‚
â”‚     â”œâ”€ Update last_activity timestamp                                               â”‚
â”‚     â””â”€ Return session valid/invalid                                                 â”‚
â”‚                                                                                     â”‚
â”‚  5. If valid, allow request to proceed                                              â”‚
â”‚  6. If invalid, return 401 Unauthorized                                             â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            SESSION REVOCATION                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  User logout or security event:                                                     â”‚
â”‚                                                                                     â”‚
â”‚  1. SessionService.RevokeSession(session_id)                                        â”‚
â”‚     â”œâ”€ Set is_active = false in PostgreSQL                                          â”‚
â”‚     â”œâ”€ Remove from Redis cache                                                      â”‚
â”‚     â”œâ”€ Add session_id to blacklist in Redis (TTL: token expiry)                    â”‚
â”‚     â””â”€ Log revocation event                                                         â”‚
â”‚                                                                                     â”‚
â”‚  2. All subsequent requests with this session fail                                  â”‚
â”‚                                                                                     â”‚
â”‚  Security scenarios triggering revocation:                                          â”‚
â”‚  â€¢ User explicit logout                                                             â”‚
â”‚  â€¢ Password change                                                                  â”‚
â”‚  â€¢ Suspicious activity detected                                                     â”‚
â”‚  â€¢ Multiple failed authentication attempts                                          â”‚
â”‚  â€¢ Admin-initiated revocation                                                       â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SESSION CLEANUP & MAINTENANCE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  Background job runs every 1 hour:                                                  â”‚
â”‚                                                                                     â”‚
â”‚  1. SessionService.CleanupExpiredSessions()                                         â”‚
â”‚     â”œâ”€ DELETE FROM sessions WHERE expires_at < NOW()                                â”‚
â”‚     â”œâ”€ Remove expired sessions from Redis                                           â”‚
â”‚     â””â”€ Log cleanup statistics                                                       â”‚
â”‚                                                                                     â”‚
â”‚  2. Monitor active sessions per user                                                â”‚
â”‚     â€¢ Alert if > 5 active sessions                                                  â”‚
â”‚     â€¢ Revoke oldest sessions if limit exceeded                                      â”‚
â”‚                                                                                     â”‚
â”‚  3. Analyze session patterns                                                        â”‚
â”‚     â€¢ Track average session duration                                                â”‚
â”‚     â€¢ Identify unusual access patterns                                              â”‚
â”‚     â€¢ Generate security reports                                                     â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Session Database Schema

```sql
CREATE TABLE sessions (
    session_id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(user_id),
    device_id VARCHAR(255) NOT NULL,
    device_type VARCHAR(50),
    device_name VARCHAR(255),
    ip_address VARCHAR(45),
    user_agent TEXT,
    location VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    last_activity TIMESTAMP NOT NULL DEFAULT NOW(),
    expires_at TIMESTAMP NOT NULL,
    is_active BOOLEAN DEFAULT true,
    revoked_at TIMESTAMP,
    revocation_reason TEXT,
    metadata JSONB,

    INDEX idx_sessions_user_id (user_id),
    INDEX idx_sessions_expires_at (expires_at),
    INDEX idx_sessions_is_active (is_active)
);
```

---

## Security Architecture

### Multi-Layer Security

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            SECURITY LAYERS                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  Layer 1: TRANSPORT SECURITY                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â€¢ TLS 1.3 encryption for all communications                                    â”‚ â”‚
â”‚  â”‚ â€¢ Certificate pinning on mobile apps                                           â”‚ â”‚
â”‚  â”‚ â€¢ HTTPS only (no HTTP allowed)                                                 â”‚ â”‚
â”‚  â”‚ â€¢ Perfect Forward Secrecy (PFS) enabled                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â”‚  Layer 2: API GATEWAY SECURITY                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â€¢ Rate limiting (per IP, per user)                                             â”‚ â”‚
â”‚  â”‚ â€¢ DDoS protection                                                              â”‚ â”‚
â”‚  â”‚ â€¢ IP whitelisting/blacklisting                                                 â”‚ â”‚
â”‚  â”‚ â€¢ Request size limits                                                          â”‚ â”‚
â”‚  â”‚ â€¢ CORS policy enforcement                                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â”‚  Layer 3: AUTHENTICATION                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â€¢ JWT token validation                                                         â”‚ â”‚
â”‚  â”‚ â€¢ Token expiration enforcement                                                 â”‚ â”‚
â”‚  â”‚ â€¢ Session validation                                                           â”‚ â”‚
â”‚  â”‚ â€¢ Multi-factor authentication (OTP)                                            â”‚ â”‚
â”‚  â”‚ â€¢ Token blacklist for revoked sessions                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â”‚  Layer 4: AUTHORIZATION                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â€¢ KYC level enforcement                                                        â”‚ â”‚
â”‚  â”‚ â€¢ Permission-based access control                                              â”‚ â”‚
â”‚  â”‚ â€¢ Resource ownership validation                                                â”‚ â”‚
â”‚  â”‚ â€¢ Scope-based API access                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â”‚  Layer 5: DATA PROTECTION                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â€¢ Password hashing (bcrypt, cost 12)                                           â”‚ â”‚
â”‚  â”‚ â€¢ OTP code hashing                                                             â”‚ â”‚
â”‚  â”‚ â€¢ Sensitive data encryption at rest                                            â”‚ â”‚
â”‚  â”‚ â€¢ PII data masking in logs                                                     â”‚ â”‚
â”‚  â”‚ â€¢ Secure token storage (Keychain, EncryptedSharedPreferences)                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â”‚  Layer 6: MONITORING & LOGGING                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â€¢ Audit log for all authentication events                                      â”‚ â”‚
â”‚  â”‚ â€¢ Failed login attempt tracking                                                â”‚ â”‚
â”‚  â”‚ â€¢ Suspicious activity detection                                                â”‚ â”‚
â”‚  â”‚ â€¢ Real-time security alerts                                                    â”‚ â”‚
â”‚  â”‚ â€¢ Comprehensive security metrics                                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Rate Limiting Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            RATE LIMITING RULES                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  Endpoint-Specific Limits:                                                           â”‚
â”‚                                                                                      â”‚
â”‚  POST /auth/otp/send                                                                 â”‚
â”‚  â”œâ”€ Per phone number: 3 requests per hour                                            â”‚
â”‚  â”œâ”€ Per IP address: 10 requests per hour                                             â”‚
â”‚  â””â”€ Global: 1000 requests per minute                                                 â”‚
â”‚                                                                                      â”‚
â”‚  POST /auth/otp/verify                                                               â”‚
â”‚  â”œâ”€ Per phone number: 5 attempts per OTP                                             â”‚
â”‚  â”œâ”€ Per IP address: 20 attempts per hour                                             â”‚
â”‚  â””â”€ Lock account after 10 failed verifications in 24h                                â”‚
â”‚                                                                                      â”‚
â”‚  POST /auth/login                                                                    â”‚
â”‚  â”œâ”€ Per user: 5 attempts per 15 minutes                                              â”‚
â”‚  â”œâ”€ Per IP address: 10 attempts per 15 minutes                                       â”‚
â”‚  â””â”€ Lock account after 5 consecutive failures                                        â”‚
â”‚                                                                                      â”‚
â”‚  POST /auth/refresh                                                                  â”‚
â”‚  â”œâ”€ Per user: 10 requests per minute                                                 â”‚
â”‚  â””â”€ Per IP address: 30 requests per minute                                           â”‚
â”‚                                                                                      â”‚
â”‚  General API (authenticated):                                                        â”‚
â”‚  â”œâ”€ Per user: 1000 requests per minute                                               â”‚
â”‚  â””â”€ Per IP address: 3000 requests per minute                                         â”‚
â”‚                                                                                      â”‚
â”‚  Implementation:                                                                     â”‚
â”‚  â€¢ Redis-based sliding window counters                                               â”‚
â”‚  â€¢ Distributed rate limiting across instances                                        â”‚
â”‚  â€¢ 429 Too Many Requests with Retry-After header                                     â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Cross-Platform Integration

### Token Storage by Platform

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       TOKEN STORAGE STRATEGIES                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  WEB (apps/web/src/)                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Primary: localStorage                                                          â”‚ â”‚
â”‚  â”‚ â€¢ Key: "tchat_access_token", "tchat_refresh_token"                             â”‚ â”‚
â”‚  â”‚ â€¢ Automatic persistence across sessions                                        â”‚ â”‚
â”‚  â”‚ â€¢ XSS protection via Content Security Policy                                   â”‚ â”‚
â”‚  â”‚                                                                                â”‚ â”‚
â”‚  â”‚ Secondary: Redux state                                                         â”‚ â”‚
â”‚  â”‚ â€¢ In-memory during active session                                              â”‚ â”‚
â”‚  â”‚ â€¢ Redux Persist syncs with localStorage                                        â”‚ â”‚
â”‚  â”‚                                                                                â”‚ â”‚
â”‚  â”‚ Security measures:                                                             â”‚ â”‚
â”‚  â”‚ â€¢ HttpOnly cookies (not used for JWT, but for CSRF token)                     â”‚ â”‚
â”‚  â”‚ â€¢ SameSite=Strict cookie policy                                                â”‚ â”‚
â”‚  â”‚ â€¢ Automatic token refresh on expiry                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â”‚  MOBILE - ANDROID (apps/kmp/.../android/)                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Primary: EncryptedSharedPreferences (Android Keystore)                         â”‚ â”‚
â”‚  â”‚ â€¢ Backed by hardware security module if available                              â”‚ â”‚
â”‚  â”‚ â€¢ AES-256-GCM encryption                                                       â”‚ â”‚
â”‚  â”‚ â€¢ Key: "auth_tokens"                                                           â”‚ â”‚
â”‚  â”‚ â€¢ Value: JSON { accessToken, refreshToken, expiresAt }                        â”‚ â”‚
â”‚  â”‚                                                                                â”‚ â”‚
â”‚  â”‚ Implementation:                                                                â”‚ â”‚
â”‚  â”‚ ```kotlin                                                                      â”‚ â”‚
â”‚  â”‚ val encryptedPrefs = EncryptedSharedPreferences.create(                        â”‚ â”‚
â”‚  â”‚     context,                                                                   â”‚ â”‚
â”‚  â”‚     "auth_prefs",                                                              â”‚ â”‚
â”‚  â”‚     masterKey,                                                                 â”‚ â”‚
â”‚  â”‚     EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,            â”‚ â”‚
â”‚  â”‚     EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM           â”‚ â”‚
â”‚  â”‚ )                                                                              â”‚ â”‚
â”‚  â”‚ ```                                                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â”‚  MOBILE - iOS (apps/kmp/.../ios/)                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Primary: iOS Keychain (kSecClassGenericPassword)                               â”‚ â”‚
â”‚  â”‚ â€¢ Hardware-backed encryption (Secure Enclave)                                  â”‚ â”‚
â”‚  â”‚ â€¢ Access control: kSecAttrAccessibleWhenUnlockedThisDeviceOnly                 â”‚ â”‚
â”‚  â”‚ â€¢ Biometric protection optional                                                â”‚ â”‚
â”‚  â”‚                                                                                â”‚ â”‚
â”‚  â”‚ Implementation:                                                                â”‚ â”‚
â”‚  â”‚ ```swift                                                                       â”‚ â”‚
â”‚  â”‚ let query: [String: Any] = [                                                   â”‚ â”‚
â”‚  â”‚     kSecClass as String: kSecClassGenericPassword,                             â”‚ â”‚
â”‚  â”‚     kSecAttrAccount as String: "auth_tokens",                                  â”‚ â”‚
â”‚  â”‚     kSecAttrService as String: "com.tchat.mobile",                             â”‚ â”‚
â”‚  â”‚     kSecValueData as String: tokenData,                                        â”‚ â”‚
â”‚  â”‚     kSecAttrAccessible as String:                                              â”‚ â”‚
â”‚  â”‚         kSecAttrAccessibleWhenUnlockedThisDeviceOnly                           â”‚ â”‚
â”‚  â”‚ ]                                                                              â”‚ â”‚
â”‚  â”‚ SecItemAdd(query as CFDictionary, nil)                                         â”‚ â”‚
â”‚  â”‚ ```                                                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Token Refresh Flow (All Platforms)

```
Client                          Auth Service
  â”‚                                  â”‚
  â”‚ 1. API request with              â”‚
  â”‚    expired access token          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 401 Unauthorized                 â”‚
  â”‚ { error: "token_expired" }       â”‚
  â”‚                                  â”‚
  â”‚ 2. Auto-trigger token refresh    â”‚
  â”‚ POST /auth/refresh               â”‚
  â”‚ { refresh_token: "..." }         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                  â”‚
  â”‚                                  â”‚ 3. Validate refresh token
  â”‚                                  â”‚    â€¢ Check signature
  â”‚                                  â”‚    â€¢ Verify not expired
  â”‚                                  â”‚    â€¢ Check not blacklisted
  â”‚                                  â”‚    â€¢ Validate session active
  â”‚                                  â”‚
  â”‚                                  â”‚ 4. Generate new token pair
  â”‚                                  â”‚    â€¢ New access token (15 min)
  â”‚                                  â”‚    â€¢ New refresh token (7 days)
  â”‚                                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 200 OK                           â”‚
  â”‚ {                                â”‚
  â”‚   access_token: "new_token",     â”‚
  â”‚   refresh_token: "new_refresh",  â”‚
  â”‚   expires_in: 900                â”‚
  â”‚ }                                â”‚
  â”‚                                  â”‚
  â”‚ 5. Store new tokens              â”‚
  â”‚    Platform-specific storage     â”‚
  â”‚                                  â”‚
  â”‚ 6. Retry original request        â”‚
  â”‚    with new access token         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 200 OK (success)                 â”‚
  â”‚                                  â”‚
```

---

## Data Flow Diagrams

### Complete Request Flow with Authentication

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               AUTHENTICATED API REQUEST FLOW                                         â”‚
â”‚            (Example: Get user profile)                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Web/Mobile Client
    â”‚
    â”‚ GET /api/v1/auth/profile
    â”‚ Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
    â”‚ X-Device-ID: device-123
    â”‚ X-App-Version: 1.2.0
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      API Gateway (Port 8080)           â”‚
â”‚                                        â”‚
â”‚  1. CORS Middleware                    â”‚
â”‚     â”œâ”€ Verify origin allowed           â”‚
â”‚     â””â”€ Add CORS headers                â”‚
â”‚                                        â”‚
â”‚  2. Security Middleware                â”‚
â”‚     â”œâ”€ Rate limit check                â”‚
â”‚     â”œâ”€ IP validation                   â”‚
â”‚     â””â”€ Request size check              â”‚
â”‚                                        â”‚
â”‚  3. Extract JWT token                  â”‚
â”‚     â””â”€ Authorization header            â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ Forward to Auth Service
                 â”‚ /auth/profile
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Auth Service (Port 8081)            â”‚
â”‚                                        â”‚
â”‚  4. Auth Middleware Chain              â”‚
â”‚     â”œâ”€ RequireAuth()                   â”‚
â”‚     â”‚  â”œâ”€ Validate JWT signature       â”‚
â”‚     â”‚  â”œâ”€ Check expiration             â”‚
â”‚     â”‚  â”œâ”€ Parse UserClaims             â”‚
â”‚     â”‚  â””â”€ Set user context             â”‚
â”‚     â”‚                                  â”‚
â”‚     â””â”€ RequireKYC(minLevel: 0)         â”‚
â”‚        â””â”€ Verify KYC level â‰¥ 0         â”‚
â”‚                                        â”‚
â”‚  5. Handler: GetProfile()              â”‚
â”‚     â”œâ”€ Extract user_id from context    â”‚
â”‚     â”œâ”€ Call UserService.GetUser()      â”‚
â”‚     â””â”€ Format response                 â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ Query user data
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Database Layer                   â”‚
â”‚                                        â”‚
â”‚  6. UserService                        â”‚
â”‚     â”œâ”€ Check Redis cache               â”‚
â”‚     â”‚  Key: "user:{user_id}"           â”‚
â”‚     â”‚                                  â”‚
â”‚     â”œâ”€ If not cached:                  â”‚
â”‚     â”‚  â””â”€ Query PostgreSQL             â”‚
â”‚     â”‚     SELECT * FROM users          â”‚
â”‚     â”‚     WHERE user_id = $1           â”‚
â”‚     â”‚                                  â”‚
â”‚     â””â”€ Cache result in Redis           â”‚
â”‚        TTL: 5 minutes                  â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ Return user data
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Auth Service Response               â”‚
â”‚                                        â”‚
â”‚  7. Format response                    â”‚
â”‚     {                                  â”‚
â”‚       user: {                          â”‚
â”‚         id: "uuid",                    â”‚
â”‚         phone_number: "+66...",        â”‚
â”‚         kyc_status: "verified",        â”‚
â”‚         created_at: "2025-01-15"       â”‚
â”‚       }                                â”‚
â”‚     }                                  â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ HTTP 200 OK
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      API Gateway                       â”‚
â”‚                                        â”‚
â”‚  8. Add response headers               â”‚
â”‚     â”œâ”€ X-Request-ID                    â”‚
â”‚     â”œâ”€ X-Response-Time                 â”‚
â”‚     â””â”€ CORS headers                    â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ Return to client
                 â”‚
                 â–¼
Web/Mobile Client
    â”‚
    â”‚ Receive user profile
    â”‚ Update UI state
    â”‚
```

---

## Summary

### Key Features

âœ… **Multi-Platform Support**: Web (React), Mobile (KMP - Android & iOS)
âœ… **JWT Token System**: Access (15 min) + Refresh (7 days) tokens
âœ… **OTP Authentication**: Primary auth method with SMS verification
âœ… **Session Management**: 30-day sessions with active tracking
âœ… **KYC Integration**: Multi-level KYC support with verification
âœ… **Rate Limiting**: Comprehensive rate limiting per endpoint
âœ… **Security Layers**: 6-layer security architecture
âœ… **Cross-Platform Sync**: Unified auth state across all clients
âœ… **Secure Storage**: Platform-specific secure token storage
âœ… **Comprehensive Logging**: Full audit trail for security analysis

### File Count by Category

- **Backend Services**: 194 files (Go)
- **Web Frontend**: 91 files (TypeScript/React)
- **Mobile Apps**: 64 files (Kotlin Multiplatform)
- **Total**: **349 authentication-related files**

### API Endpoints Summary

**Auth Service (8081)**:
- `POST /auth/otp/send` - Request OTP
- `POST /auth/otp/verify` - Verify OTP and login
- `POST /auth/register` - Register with email/password
- `POST /auth/login` - Login with email/password
- `POST /auth/refresh` - Refresh access token
- `POST /auth/logout` - Logout and revoke session
- `GET /auth/profile` - Get user profile [Protected]
- `PUT /auth/profile` - Update user profile [Protected]
- `POST /auth/kyc/verify` - Verify KYC documents [Protected]
- `GET /auth/session` - Get session details [Protected]

---

**Generated by**: Agent System (SearchAgent + CodeAgent + Architect Persona)
**Last Updated**: 2025-09-30
**Version**: 1.0